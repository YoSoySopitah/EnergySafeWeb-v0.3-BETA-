{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Información del dispositivo - EnergySafe</title>
    <link rel='stylesheet' href="{% static 'css/devices.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/radar.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>
<body>
    <div class="header-container">
        <div class="logo">
            <a href="{% url 'home' %}">
                <img src="https://i.imgur.com/M8s3mYZ.png" alt="Logo de EnergySafe">
            </a>
        </div>
        <div class="optios">
            <a href="/home"><h2>Inicio</h2></a>
            <a href="/download"><h2>Descargar</h2></a>
            <a href="/devices"><h2>Dispositivos</h2></a>
            <a href="/products"><h2>Productos</h2></a>
            <a href="/about-us"><h2>Acerca de nosotros</h2></a>
            {% if user.is_authenticated %}
                <a href="{% url 'logout' %}" id="Login-Register"><h2>Cerrar sesión</h2></a>
            {% else %}
                <a href="{% url 'login' %}" id="Login-Register"><h2>Login/Register</h2></a>
            {% endif %}
        </div>
    </div>
    <div class="container">
        <div class="first-part">
            <img src="https://i.imgur.com/Gc9kzyb.png" alt="">
            <div class="voltaje">
                <hr>
                <h1 id="voltaje-text">VOLTAJE</h1>
                <div class="circle-v">
                    <img id="circle-v" src="https://i.imgur.com/BR1kvFH.png" alt="">
                    <img id="flash-v" src="https://i.imgur.com/dKBjb76.png" alt="">
                </div>
                <div class="information-v">
                    <h1 id="voltaje-v">{{ latest_consumption.voltaje|floatformat:0 }}V</h1>
                    <h3 id="voltaje-date">{{ latest_consumption.fecha|date:"F j Y" }}</h3>
                    <div class="porcentaje-v">
                        <img src="https://i.imgur.com/NHR1Q8A.png" alt="">
                        <h2 id="voltaje-porcentaje">
                            {% if voltage_stats.avg > 0 %}
                                {{ voltage_stats.avg|floatformat:0 }}% promedio
                            {% else %}
                                2% desde ayer
                            {% endif %}
                        </h2>
                    </div>
                </div>
            </div>
            <div class="kwh">
                <hr>
                <h3 id="kwh-text">kWh CONSUMIDOS</h3>
                <div class="kwh-text"></div>
                <div class="kwh-dashboard">
                    <div class="dashboard">
                        <div class="kwh-info">
                            <h1 id="kw">{{ latest_consumption.consumo|floatformat:1 }} <span>kWh</span></h1>
                        </div>
                        <div class="chart" id="consumption-chart">
                            <div class="bar-container">
                                <div class="bar" id="bar-lun"></div>
                                <div class="day">Lun</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" id="bar-mar"></div>
                                <div class="day">Mar</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" id="bar-mir"></div>
                                <div class="day">Mir</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" id="bar-jue"></div>
                                <div class="day">Jue</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" id="bar-vie"></div>
                                <div class="day">Vie</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" id="bar-sab"></div>
                                <div class="day">Sab</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" id="bar-dom"></div>
                                <div class="day">Dom</div>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard2">
                        <div class="grafico-circular-container">
                            <div class="grafico-circular-wrapper">
                                <div class="grafico-container">
                                    <canvas id="grafico-circular" width="197" height="197"></canvas>
                                    <div class="tooltip" id="tooltip"></div>
                                </div>
                                <div class="leyenda-container" id="leyenda">
                                    <!-- La leyenda se generará dinámicamente con JavaScript -->
                                </div>
                            </div>
                        </div>
                        <h1>{{ latest_consumption.consumo|floatformat:1 }}kWh</h1>
                        <h3>{{ latest_consumption.fecha|date:"F j Y" }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="second-part">
            <div class="amperios">
                <hr>
                <h1 id="amperios-text">Amperios</h1>
                <div class="amperios-info">
                    <div class="chart-container">
                        <div id="chartdiv1" class="chartdiv"></div>
                    </div>
                    <div class="information-a">
                        <h1 id="amperios-a">{{ latest_consumption.corriente|floatformat:1 }} <span>A</span></h1>
                        <h3 id="amperios-date">{{ latest_consumption.fecha|date:"F j Y" }}</h3>
                        <div class="porcentaje-a">
                            <img src="https://i.imgur.com/NHR1Q8A.png" alt="">
                            <h2 id="amperios-porcentaje">
                                {% if current_stats.avg > 0 %}
                                    {{ current_stats.avg|floatformat:0 }}% promedio
                                {% else %}
                                    2% desde ayer
                                {% endif %}
                            </h2>
                        </div>
                    </div>
                    <div class="circle-a">
                        <img id="circle-a" src="https://i.imgur.com/BR1kvFH.png" alt="">
                        <img id="flash-a" src="https://i.imgur.com/EeXnkJx.png" alt="">
                    </div>
                </div>
            </div>

            <div class="corriente">
                <hr>
                <h1 id="amperios-text">Corriente</h1>
                <div class="amperios-info">
                    <div class="circle-a">
                        <img id="circle-a" src="https://i.imgur.com/BR1kvFH.png" alt="">
                        <img id="flash-a" src="https://i.imgur.com/J1obQa6.png" alt="">
                    </div>
                    <div class="chart-container">
                        <div id="chartdiv2" class="chartdiv"></div>
                    </div>
                    <div class="information-a">
                        <h1 id="amperios-a">{{ latest_consumption.potencia|floatformat:0 }} <span>W</span></h1>
                        <h3 id="amperios-date">{{ latest_consumption.fecha|date:"F j Y" }}</h3>
                        <div class="porcentaje-a">
                            <img src="https://i.imgur.com/NHR1Q8A.png" alt="">
                            <h2 id="amperios-porcentaje">
                                {% if current_stats.avg > 0 %}
                                    {{ current_stats.avg|floatformat:0 }}% promedio
                                {% else %}
                                    2% desde ayer
                                {% endif %}
                            </h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dispositivo-monitor-wrapper" id="monitorizacion-dispositivos">
            <div class="info-box">
                <table id="dispositivo-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Voltaje</th>
                            <th>Corriente</th>
                            <th>Potencia</th>
                            <th>Consumo</th>
                            <th>Frecuencia</th>
                        </tr>
                    </thead>
                    <div class="table-info">
                        <tbody>
                            {% for item in consumption_history %}
                            <tr>
                                <td>#{{ forloop.counter }}</td>
                                <td>
                                    {% if item.fecha|date %}
                                        {{ item.fecha|date:"Y/m/d" }}<br>{{ item.fecha|time:"H:i:s" }}
                                    {% else %}
                                        {{ item.fecha }}
                                    {% endif %}
                                </td>
                                <td>{{ item.voltaje|floatformat:0 }} v</td>
                                <td>{{ item.corriente|floatformat:1 }} A</td>
                                <td>{{ item.potencia|floatformat:0 }} w</td>
                                <td>{{ item.consumo|floatformat:1 }} kWh</td>
                                <td>
                                    {% if item.frecuencia %}
                                        {{ item.frecuencia|floatformat:0 }}Hz
                                    {% else %}
                                        60Hz
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td>#1</td>
                                <td>{{ latest_consumption.fecha|date:"Y/m/d" }}<br>{{ latest_consumption.fecha|time:"H:i:s" }}</td>
                                <td>{{ latest_consumption.voltaje|floatformat:0 }} v</td>
                                <td>{{ latest_consumption.corriente|floatformat:1 }} A</td>
                                <td>{{ latest_consumption.potencia|floatformat:0 }} w</td>
                                <td>{{ latest_consumption.consumo|floatformat:1 }} kWh</td>
                                <td>60Hz</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
        
                <h2 id="alert-text">Historial de Alertas</h2>
                
                <div class="info-box">
                    <div class="alert-header"><h2>Anomalías detectadas</h2></div>
                    <div id="alertas-container">
                        {% for alert in alerts %}
                        <div class="alert-item">
                            <div class="alert-icon"><img src="https://i.imgur.com/j3d5GBP.png" alt=""></div>
                            <div id="alert-alarm">
                                {% if alert.mensaje %}
                                    {{ alert.mensaje }}
                                {% else %}
                                    {{ alert }}
                                {% endif %}
                            </div>
                            <div class="close-btn">✕</div>
                        </div>
                        {% empty %}
                        <div class="alert-item">
                            <div class="alert-icon"><img src="https://i.imgur.com/j3d5GBP.png" alt=""></div>
                            <div id="alert-alarm">No hay alertas activas en este momento.</div>
                            <div class="close-btn">✕</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Valores de consumo diario desde el servidor
        const defaultValues = {{ daily_consumption|safe }};
        
        // Función para actualizar el gráfico con los valores dados
        function updateChart(values) {
            const maxValue = Math.max(...Object.values(values)) * 1.2; // 20% más que el máximo valor
            const maxHeight = 150; // Altura máxima en píxeles
            
            Object.keys(values).forEach(day => {
                const value = values[day];
                const bar = document.getElementById(`bar-${day}`);
                
                if (bar) {
                    // Calcular altura relativa (mínimo 10px para que se vea incluso si es > 0)
                    const height = value === 0 ? 0 : Math.max(10, (value / maxValue) * maxHeight);
                    
                    bar.style.height = `${height}px`;
                    bar.textContent = value.toFixed(1);
                }
            });
        }
        
        // Inicializar el gráfico con valores desde el servidor
        window.onload = function() {
            updateChart(defaultValues);
        };
    </script>

    <script>
        window.onscroll = function() {
            var header = document.querySelector('.header-container');
            if (window.scrollY > 50) { // Cuando el scroll pase de 50px
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        };
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Cerrar alertas
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.alert-item').remove();
                });
            });
        });
    </script>

    <script>
        // Datos para el gráfico circular desde el servidor
        const datos = {{ pie_chart_data|safe }};

        // Obtener el contexto del canvas
        const canvas = document.getElementById('grafico-circular');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        const leyendaContainer = document.getElementById('leyenda');
        
        // Establecer el tamaño del canvas
        canvas.width = 197;
        canvas.height = 197;
        
        // Calcular el total
        function calcularTotal() {
            return datos.reduce((total, item) => total + item.valor, 0);
        }

        // Dibujar el gráfico circular con agujero interior blanco
        function dibujarGrafico() {
            // Limpiar el canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const total = calcularTotal();
            const radio = (Math.min(canvas.width, canvas.height) / 2) - 10;
            const centroX = canvas.width / 2;
            const centroY = canvas.height / 2;

            let anguloInicial = -Math.PI / 2; // Comenzar desde arriba

            // Dibujar cada segmento
            datos.forEach(item => {
                if (item.valor <= 0) return; // Omitir elementos con valor 0

                const angulo = (item.valor / total) * (Math.PI * 2);
                const anguloFinal = anguloInicial + angulo;

                // Dibujar segmento
                ctx.beginPath();
                ctx.moveTo(centroX, centroY);
                ctx.arc(centroX, centroY, radio, anguloInicial, anguloFinal);
                ctx.closePath();

                ctx.fillStyle = item.color;
                ctx.fill();

                // Actualizar ángulo inicial para el siguiente segmento
                anguloInicial = anguloFinal;
            });

            // Dibujar el círculo blanco en el centro para simular el agujero
            ctx.beginPath();
            ctx.arc(centroX, centroY, radio / 1.5, 0, Math.PI * 2, false); // Radio más pequeño
            ctx.fillStyle = "white"; // Color blanco
            ctx.fill();
        }

        // Crear la leyenda
        function crearLeyenda() {
            leyendaContainer.innerHTML = '';
            
            datos.forEach((item, index) => {
                if (item.valor <= 0) return; // No mostrar elementos con valor 0
                
                const leyendaItem = document.createElement('div');
                leyendaItem.className = 'leyenda-item';
                leyendaItem.dataset.index = index;
                
                const leyendaColor = document.createElement('div');
                leyendaColor.className = 'leyenda-color';
                leyendaColor.style.backgroundColor = item.color;
                
                const leyendaTexto = document.createElement('div');
                leyendaTexto.className = 'leyenda-texto';
                leyendaTexto.textContent = item.nombre;
                
                leyendaItem.appendChild(leyendaColor);
                leyendaItem.appendChild(leyendaTexto);
                leyendaContainer.appendChild(leyendaItem);
                
                // Evento para resaltar al pasar el ratón
                leyendaItem.addEventListener('mouseover', () => {
                    resaltarSegmento(index);
                });
                
                // Evento para restaurar al quitar el ratón
                leyendaItem.addEventListener('mouseout', () => {
                    dibujarGrafico();
                    tooltip.style.opacity = 0;
                });
            });
        }

        // Función para resaltar un segmento
        function resaltarSegmento(index) {
            if (datos[index].valor <= 0) return;
            
            // Dibujar el gráfico base
            dibujarGrafico();
            
            // Calcular la posición del segmento
            const total = calcularTotal();
            const radio = (Math.min(canvas.width, canvas.height) / 2) - 10;
            const centroX = canvas.width / 2;
            const centroY = canvas.height / 2;
            const radioResaltado = radio * 1.05; // Ligeramente más grande
            
            let anguloInicial = -Math.PI / 2; // Comenzar desde arriba
            for (let i = 0; i < index; i++) {
                if (datos[i].valor > 0) {
                    anguloInicial += (datos[i].valor / total) * (Math.PI * 2);
                }
            }
            
            const angulo = (datos[index].valor / total) * (Math.PI * 2);
            const anguloFinal = anguloInicial + angulo;
            const anguloMedio = anguloInicial + (angulo / 2);
            
            // Redibujar el segmento resaltado
            ctx.beginPath();
            ctx.moveTo(centroX, centroY);
            ctx.arc(centroX, centroY, radioResaltado, anguloInicial, anguloFinal);
            ctx.closePath();
            
            ctx.fillStyle = datos[index].color;
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'white';
            ctx.stroke();
            
            // Mostrar tooltip
            const tooltipX = centroX + (radio * 0.75) * Math.cos(anguloMedio);
            const tooltipY = centroY + (radio * 0.75) * Math.sin(anguloMedio);
            
            tooltip.style.left = `${tooltipX}px`;
            tooltip.style.top = `${tooltipY}px`;
            tooltip.textContent = `${datos[index].nombre}: ${datos[index].valor} (${Math.round((datos[index].valor / total) * 100)}%)`;
            tooltip.style.opacity = 1;
        }
        
        // Actualizar el gráfico
        function actualizarGrafico() {
            dibujarGrafico();
            crearLeyenda();
        }
        
        // Inicializar el gráfico
        actualizarGrafico();
    </script>

    <script>
        function createGaugeChart(chartId) {
            var root = am5.Root.new(chartId);
            root._logo.dispose();
            root.setThemes([
                am5themes_Animated.new(root)
            ]);
            var chart = root.container.children.push(
                am5radar.RadarChart.new(root, {
                    panX: false,
                    panY: false,
                    startAngle: 180,
                    endAngle: 360
                })
            );
            var axisRenderer = am5radar.AxisRendererCircular.new(root, {
                innerRadius: -10,
                strokeOpacity: 1,
                strokeWidth: 25,
                strokeGradient: am5.LinearGradient.new(root, {
                    rotation: 0,
                    stops: [
                        { color: am5.color(0x19d228) },
                        { color: am5.color(0xf4fb16) },
                        { color: am5.color(0xf6d32b) },
                        { color: am5.color(0xfb7116) }
                    ]
                })
            });
            var xAxis = chart.xAxes.push(
                am5xy.ValueAxis.new(root, {
                    maxDeviation: 0,
                    min: 0,
                    max: 100,
                    strictMinMax: true,
                    renderer: axisRenderer
                })
            );
            var axisDataItem = xAxis.makeDataItem({});
            axisDataItem.set("value", 0);
            var bullet = axisDataItem.set("bullet", am5xy.AxisBullet.new(root, {
                sprite: am5radar.ClockHand.new(root, {
                    radius: am5.percent(99)
                })
            }));
            xAxis.createAxisRange(axisDataItem);
            axisDataItem.get("grid").set("visible", false);
            
            // Mostrar valores reales en lugar de aleatorios
            {% if latest_consumption.voltaje and voltage_stats.max %}
                // Para el primer gráfico (voltaje), ajustar el valor entre 0-100 basado en voltaje máximo
                if (chartId === "chartdiv1") {
                    let voltageValue = ({{ latest_consumption.voltaje }} / {{ voltage_stats.max }} * 100);
                    voltageValue = Math.min(Math.max(voltageValue, 0), 100); // Limitar entre 0-100
                    
                    axisDataItem.animate({
                        key: "value",
                        to: voltageValue,
                        duration: 800,
                        easing: am5.ease.out(am5.ease.cubic)
                    });
                }
                // Para el segundo gráfico (corriente), ajustar el valor entre 0-100 basado en corriente máxima
                else if (chartId === "chartdiv2") {
                    let currentValue = ({{ latest_consumption.corriente }} / {{ current_stats.max }} * 100);
                    currentValue = Math.min(Math.max(currentValue, 0), 100); // Limitar entre 0-100
                    
                    axisDataItem.animate({
                        key: "value",
                        to: currentValue,
                        duration: 800,
                        easing: am5.ease.out(am5.ease.cubic)
                    });
                }
            {% else %}
                // Valores aleatorios si no hay datos reales
                setInterval(() => {
                    axisDataItem.animate({
                        key: "value",
                        to: Math.round(Math.random() * 100),
                        duration: 800,
                        easing: am5.ease.out(am5.ease.cubic)
                    });
                }, 2000);
            {% endif %}
            
            chart.appear(1000, 100);
        }
        
        am5.ready(function() {
            createGaugeChart("chartdiv1");
            createGaugeChart("chartdiv2");
        });
    </script>
</body>
</html>